name: Retools PR Generator

on:
  workflow_dispatch:
    inputs:
      job_payload:
        description: 'JSON payload containing job details'
        required: true
        type: string

jobs:
  generate-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===================================================================
      # STEP 0: Checkout Retools Builder Engine (for scripts)
      # ===================================================================
      - name: Checkout Retools Builder Engine
        uses: actions/checkout@v4
        with:
          path: retools-engine

      # ===================================================================
      # STEP 1: Parse Job Payload
      # ===================================================================
      - name: Parse Job Payload
        id: parse
        run: |
          echo "Parsing job payload..."
          cat > /tmp/job_payload.json << 'EOF'
          ${{ inputs.job_payload }}
          EOF
          
          JOB_ID=$(jq -r '.job_id' /tmp/job_payload.json)
          REPO_URL=$(jq -r '.repo_url' /tmp/job_payload.json)
          BRANCH=$(jq -r '.branch' /tmp/job_payload.json)
          PROMPT=$(jq -r '.prompt' /tmp/job_payload.json)
          WEBHOOK_URL=$(jq -r '.webhook_url' /tmp/job_payload.json)
          USER_EMAIL=$(jq -r '.user_email // empty' /tmp/job_payload.json)
          USER_NAME=$(jq -r '.user_name // empty' /tmp/job_payload.json)
          
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "user_email=$USER_EMAIL" >> $GITHUB_OUTPUT
          echo "user_name=$USER_NAME" >> $GITHUB_OUTPUT
          
          # Extract owner/repo from URL
          REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
          echo "repo_path=$REPO_PATH" >> $GITHUB_OUTPUT
          
          # Store prompt in file (avoid command injection)
          echo "$PROMPT" > /tmp/prompt.txt
          
          echo "âœ… Parsed job: $JOB_ID for $REPO_PATH"

      # ===================================================================
      # STEP 2: Mask User GitHub Token
      # ===================================================================
      - name: Setup User GitHub Token
        id: token
        run: |
          # Extract and mask user's GitHub token
          USER_TOKEN=$(jq -r '.github_token' /tmp/job_payload.json)
          echo "::add-mask::$USER_TOKEN"
          
          # Store in temp file (never in GITHUB_OUTPUT)
          echo "$USER_TOKEN" > /tmp/user_github_token.txt
          chmod 600 /tmp/user_github_token.txt
          
          echo "âœ… User GitHub token masked and stored securely"

      # ===================================================================
      # STEP 3: Checkout User's Repository
      # ===================================================================
      - name: Checkout User Repository
        run: |
          echo "Cloning ${{ steps.parse.outputs.repo_url }}..."
          
          USER_TOKEN=$(cat /tmp/user_github_token.txt)
          
          # Clone with user's token
          git clone "https://x-access-token:${USER_TOKEN}@github.com/${{ steps.parse.outputs.repo_path }}.git" repo
          cd repo
          
          # Checkout target branch
          git checkout "${{ steps.parse.outputs.branch }}" || git checkout -b "${{ steps.parse.outputs.branch }}"
          
          # Configure git
          git config user.email "${{ steps.parse.outputs.user_email || 'retools@nexartis.com' }}"
          git config user.name "${{ steps.parse.outputs.user_name || 'Retools AI' }}"
          
          echo "âœ… Repository cloned and configured"

      # ===================================================================
      # STEP 4: Send Webhook - Cloning Complete
      # ===================================================================
      - name: Webhook - Cloning Complete
        if: always()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "cloning" \
            --message "Repository cloned successfully" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 5: Setup Node.js and Dependencies
      # ===================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@9.0.0

      - name: Detect and Install Dependencies
        working-directory: ./repo
        run: |
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ Installing Node.js dependencies..."
            if [ -f "pnpm-lock.yaml" ]; then
              pnpm install
            elif [ -f "yarn.lock" ]; then
              npm install -g yarn
              yarn install
            else
              npm install
            fi
          elif [ -f "requirements.txt" ]; then
            echo "ðŸ Installing Python dependencies..."
            pip install -r requirements.txt
          elif [ -f "Gemfile" ]; then
            echo "ðŸ’Ž Installing Ruby dependencies..."
            bundle install
          else
            echo "â„¹ï¸  No dependency file found, skipping install"
          fi

      # ===================================================================
      # STEP 6: Send Webhook - Starting AI Customization
      # ===================================================================
      - name: Webhook - Starting Customization
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "customizing" \
            --message "AI is analyzing and customizing your code..." \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 7: Apply AI Changes
      # ===================================================================
      - name: Apply AI Changes with Claude
        working-directory: ./repo
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ¤– Applying AI changes..."

          PROMPT=$(cat /tmp/prompt.txt)

          # Use Claude API to generate changes
          node ../retools-engine/scripts/ai-driver.js \
            --prompt "$PROMPT" \
            --working-dir "$(pwd)"

          echo "âœ… AI changes applied"

      # ===================================================================
      # STEP 8: Commit Changes
      # ===================================================================
      - name: Commit Changes
        working-directory: ./repo
        run: |
          # Check if there are changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸  No changes detected"
            exit 0
          fi

          git add .
          git commit -m "ðŸ¤– Retools AI: $(head -n 1 /tmp/prompt.txt | cut -c1-72)"

          echo "âœ… Changes committed"

      # ===================================================================
      # STEP 9: Send Webhook - Starting Build Validation
      # ===================================================================
      - name: Webhook - Starting Build
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "building" \
            --message "Validating build with AI auto-fix..." \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 10: Build and Auto-Fix Loop (Up to 3 AI Attempts)
      # ===================================================================
      - name: Build with AI Auto-Fix
        id: build
        working-directory: ./repo
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          BUILD_SUCCESS=false

          # Check if project has a build script
          if [ ! -f "package.json" ]; then
            echo "â„¹ï¸  No package.json found, skipping build validation"
            echo "build_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          BUILD_SCRIPT=$(jq -r '.scripts.build // empty' package.json)
          if [ -z "$BUILD_SCRIPT" ]; then
            echo "â„¹ï¸  No build script found in package.json, skipping build validation"
            echo "build_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine package manager
          if [ -f "pnpm-lock.yaml" ]; then
            PKG_MANAGER="pnpm"
          elif [ -f "yarn.lock" ]; then
            PKG_MANAGER="yarn"
          else
            PKG_MANAGER="npm"
          fi

          echo "ðŸ“¦ Using package manager: $PKG_MANAGER"

          # Build and auto-fix loop
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "ðŸ”¨ Build Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            # Try to build
            BUILD_OUTPUT=$(mktemp)
            if [ "$PKG_MANAGER" = "pnpm" ]; then
              pnpm build > "$BUILD_OUTPUT" 2>&1 && BUILD_SUCCESS=true || BUILD_SUCCESS=false
            elif [ "$PKG_MANAGER" = "yarn" ]; then
              yarn build > "$BUILD_OUTPUT" 2>&1 && BUILD_SUCCESS=true || BUILD_SUCCESS=false
            else
              npm run build > "$BUILD_OUTPUT" 2>&1 && BUILD_SUCCESS=true || BUILD_SUCCESS=false
            fi

            if [ "$BUILD_SUCCESS" = true ]; then
              echo "âœ… Build successful on attempt $ATTEMPT!"
              echo "build_success=true" >> $GITHUB_OUTPUT
              echo "build_attempts=$ATTEMPT" >> $GITHUB_OUTPUT
              rm -f "$BUILD_OUTPUT"
              exit 0
            fi

            # Build failed
            echo "âŒ Build failed on attempt $ATTEMPT"
            cat "$BUILD_OUTPUT"

            # If this was the last attempt, fail
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo ""
              echo "ðŸ’” Build failed after $MAX_ATTEMPTS attempts. Giving up."
              echo "build_success=false" >> $GITHUB_OUTPUT
              echo "build_attempts=$ATTEMPT" >> $GITHUB_OUTPUT
              rm -f "$BUILD_OUTPUT"
              exit 1
            fi

            # Send webhook about fix attempt
            echo ""
            echo "ðŸ“¡ Sending webhook - AI attempting fix $ATTEMPT..."
            node ../retools-engine/scripts/webhook-driver.js \
              --job-id "${{ steps.parse.outputs.job_id }}" \
              --status "building" \
              --message "Build failed, AI attempting fix $ATTEMPT of 3..." \
              --webhook-url "${{ steps.parse.outputs.webhook_url }}"

            # Ask AI to fix the build error
            echo ""
            echo "ðŸ¤– Asking AI to fix build errors (attempt $ATTEMPT)..."

            # Create fix prompt with build error
            echo "The previous changes caused a build failure. Please analyze the build error below and fix the issues." > /tmp/fix_prompt.txt
            echo "" >> /tmp/fix_prompt.txt
            echo "BUILD ERROR:" >> /tmp/fix_prompt.txt
            cat "$BUILD_OUTPUT" >> /tmp/fix_prompt.txt

            # Run AI fix
            node ../retools-engine/scripts/ai-driver.js \
              --prompt "$(cat /tmp/fix_prompt.txt)" \
              --working-dir "$(pwd)" \
              --fix-mode

            # Commit the fix
            if [ -n "$(git status --porcelain)" ]; then
              git add .
              git commit -m "ðŸ”§ AI Auto-fix attempt $ATTEMPT: Fix build errors"
              echo "âœ… AI applied fixes, retrying build..."
            else
              echo "âš ï¸  AI made no changes, retrying anyway..."
            fi

            rm -f "$BUILD_OUTPUT"
            ATTEMPT=$((ATTEMPT + 1))
          done

      # ===================================================================
      # STEP 10: Send Webhook - Build Complete
      # ===================================================================
      - name: Webhook - Build Complete
        if: steps.build.outputs.build_success == 'true'
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          ATTEMPTS="${{ steps.build.outputs.build_attempts }}"
          if [ "$ATTEMPTS" = "1" ]; then
            MESSAGE="Build successful on first attempt"
          else
            MESSAGE="Build successful after $ATTEMPTS AI fix attempts"
          fi

          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "building" \
            --message "$MESSAGE" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 11: Send Webhook - Starting Deployment
      # ===================================================================
      - name: Webhook - Starting Deployment
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "deploying" \
            --message "Creating pull request..." \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 12: Push Branch
      # ===================================================================
      - name: Push Branch
        working-directory: ./repo
        run: |
          USER_TOKEN=$(cat /tmp/user_github_token.txt)

          # Create feature branch
          FEATURE_BRANCH="retools/ai-changes-$(date +%s)"
          git checkout -b "$FEATURE_BRANCH"

          # Push with user's token
          git remote set-url origin "https://x-access-token:${USER_TOKEN}@github.com/${{ steps.parse.outputs.repo_path }}.git"
          git push -u origin "$FEATURE_BRANCH"

          echo "feature_branch=$FEATURE_BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… Branch pushed: $FEATURE_BRANCH"
        id: push

      # ===================================================================
      # STEP 13: Create Pull Request
      # ===================================================================
      - name: Create Pull Request
        id: pr
        run: |
          USER_TOKEN=$(cat /tmp/user_github_token.txt)
          PROMPT=$(cat /tmp/prompt.txt)

          # Create PR using GitHub API
          PR_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer $USER_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ steps.parse.outputs.repo_path }}/pulls" \
            -d "{
              \"title\": \"ðŸ¤– Retools AI: ${PROMPT:0:72}\",
              \"body\": \"## AI-Generated Changes\n\n**Prompt:**\n\n${PROMPT}\n\n---\n\n*Generated by [Retools](https://retools.dev) - AI-powered PR generator*\",
              \"head\": \"${{ steps.push.outputs.feature_branch }}\",
              \"base\": \"${{ steps.parse.outputs.branch }}\"
            }")

          PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          echo "âœ… Pull Request created: $PR_URL"

      # ===================================================================
      # STEP 14: Send Success Webhook
      # ===================================================================
      - name: Webhook - Success
        if: success()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "preview_ready" \
            --message "PR created successfully - ready for review" \
            --pr-url "${{ steps.pr.outputs.pr_url }}" \
            --pr-number "${{ steps.pr.outputs.pr_number }}" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 15: Send Failure Webhook
      # ===================================================================
      - name: Webhook - Failure
        if: failure()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "failed" \
            --message "Workflow failed - check logs" \
            --github-run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 14: Cleanup
      # ===================================================================
      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f /tmp/user_github_token.txt
          rm -f /tmp/job_payload.json
          rm -f /tmp/prompt.txt
          echo "âœ… Cleanup complete"


