name: Retools PR Generator

on:
  workflow_dispatch:
    inputs:
      job_payload:
        description: 'JSON payload containing job details'
        required: true
        type: string

jobs:
  generate-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===================================================================
      # STEP 0: Checkout Retools Builder Engine (for scripts)
      # ===================================================================
      - name: Checkout Retools Builder Engine
        uses: actions/checkout@v4
        with:
          path: retools-engine

      # ===================================================================
      # STEP 1: Parse Job Payload
      # ===================================================================
      - name: Parse Job Payload
        id: parse
        run: |
          echo "Parsing job payload..."
          cat > /tmp/job_payload.json << 'EOF'
          ${{ inputs.job_payload }}
          EOF
          
          JOB_ID=$(jq -r '.job_id' /tmp/job_payload.json)
          REPO_URL=$(jq -r '.repo_url' /tmp/job_payload.json)
          BRANCH=$(jq -r '.branch' /tmp/job_payload.json)
          PROMPT=$(jq -r '.prompt' /tmp/job_payload.json)
          WEBHOOK_URL=$(jq -r '.webhook_url' /tmp/job_payload.json)
          USER_EMAIL=$(jq -r '.user_email // empty' /tmp/job_payload.json)
          USER_NAME=$(jq -r '.user_name // empty' /tmp/job_payload.json)
          
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "user_email=$USER_EMAIL" >> $GITHUB_OUTPUT
          echo "user_name=$USER_NAME" >> $GITHUB_OUTPUT
          
          # Extract owner/repo from URL
          REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
          echo "repo_path=$REPO_PATH" >> $GITHUB_OUTPUT
          
          # Store prompt in file (avoid command injection)
          echo "$PROMPT" > /tmp/prompt.txt
          
          echo "âœ… Parsed job: $JOB_ID for $REPO_PATH"

      # ===================================================================
      # STEP 2: Mask User GitHub Token
      # ===================================================================
      - name: Setup User GitHub Token
        id: token
        run: |
          # Extract and mask user's GitHub token
          USER_TOKEN=$(jq -r '.github_token' /tmp/job_payload.json)
          echo "::add-mask::$USER_TOKEN"
          
          # Store in temp file (never in GITHUB_OUTPUT)
          echo "$USER_TOKEN" > /tmp/user_github_token.txt
          chmod 600 /tmp/user_github_token.txt
          
          echo "âœ… User GitHub token masked and stored securely"

      # ===================================================================
      # STEP 3: Checkout User's Repository
      # ===================================================================
      - name: Checkout User Repository
        id: checkout
        run: |
          echo "Cloning ${{ steps.parse.outputs.repo_url }}..."

          USER_TOKEN=$(cat /tmp/user_github_token.txt)

          # Clone with user's token
          git clone "https://x-access-token:${USER_TOKEN}@github.com/${{ steps.parse.outputs.repo_path }}.git" repo
          cd repo

          # Auto-detect the real default branch.
          # Use the requested branch if it exists on the remote; otherwise fall back
          # to the repo's actual default (handles main vs master mismatch).
          REQUESTED_BRANCH="${{ steps.parse.outputs.branch }}"
          if git show-ref --verify --quiet "refs/remotes/origin/${REQUESTED_BRANCH}"; then
            BASE_BRANCH="$REQUESTED_BRANCH"
            echo "âœ… Using requested branch: $BASE_BRANCH"
          else
            BASE_BRANCH=$(git symbolic-ref refs/remotes/origin/HEAD 2>/dev/null | sed 's|refs/remotes/origin/||' || echo "master")
            echo "âš ï¸  Branch '$REQUESTED_BRANCH' not found on remote. Using default: $BASE_BRANCH"
          fi

          git checkout "$BASE_BRANCH"

          # Create a feature branch for all AI changes â€” immediately, before any work.
          # This ensures changes are always on an isolated branch, never directly on
          # the default branch.
          JOB_ID="${{ steps.parse.outputs.job_id }}"
          SHORT_ID="${JOB_ID:4:8}"
          FEATURE_BRANCH="noelle/${SHORT_ID}"
          git checkout -b "$FEATURE_BRANCH"

          # Configure git
          git config user.email "${{ steps.parse.outputs.user_email || 'noelle@nexartis.com' }}"
          git config user.name "${{ steps.parse.outputs.user_name || 'Noelle AI' }}"

          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
          echo "feature_branch=$FEATURE_BRANCH" >> $GITHUB_OUTPUT

          echo "âœ… Repository cloned. Working on branch: $FEATURE_BRANCH (base: $BASE_BRANCH)"

      # ===================================================================
      # STEP 4: Send Webhook - Cloning Complete
      # ===================================================================
      - name: Webhook - Cloning Complete
        if: always()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "cloning" \
            --message "Repository cloned successfully" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 5: Setup Node.js and Dependencies
      # ===================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@9.0.0

      - name: Detect and Install Dependencies
        working-directory: ./repo
        run: |
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ Installing Node.js dependencies..."
            if [ -f "pnpm-lock.yaml" ]; then
              pnpm install
            elif [ -f "yarn.lock" ]; then
              npm install -g yarn
              yarn install
            else
              npm install
            fi
          elif [ -f "requirements.txt" ]; then
            echo "ðŸ Installing Python dependencies..."
            pip install -r requirements.txt
          elif [ -f "Gemfile" ]; then
            echo "ðŸ’Ž Installing Ruby dependencies..."
            bundle install
          else
            echo "â„¹ï¸  No dependency file found, skipping install"
          fi

      # ===================================================================
      # STEP 6: Send Webhook - Starting AI Customization
      # ===================================================================
      - name: Webhook - Starting Customization
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "customizing" \
            --message "AI is analyzing and customizing your code..." \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 7: Apply AI Changes
      # ===================================================================
      - name: Apply AI Changes with Claude
        working-directory: ./repo
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ¤– Applying AI changes..."

          PROMPT=$(cat /tmp/prompt.txt)

          # Use Claude API to generate changes
          node ../retools-engine/scripts/ai-driver.js \
            --prompt "$PROMPT" \
            --working-dir "$(pwd)"

          echo "âœ… AI changes applied"

      # ===================================================================
      # STEP 8: Commit Changes
      # ===================================================================
      - name: Commit Changes
        working-directory: ./repo
        run: |
          # Check if there are changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸  No changes detected"
            exit 0
          fi

          git add .
          git commit -m "ðŸ¤– Retools AI: $(head -n 1 /tmp/prompt.txt | cut -c1-72)"

          echo "âœ… Changes committed"

      # ===================================================================
      # STEP 9: Send Webhook - Starting Build Validation
      # ===================================================================
      - name: Webhook - Starting Build
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "building" \
            --message "Validating build with AI auto-fix..." \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 10: Build and Auto-Fix Loop (Up to 3 AI Attempts)
      # ===================================================================
      - name: Build with AI Auto-Fix
        id: build
        working-directory: ./repo
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          BUILD_SUCCESS=false

          # Check if project has a build script
          if [ ! -f "package.json" ]; then
            echo "â„¹ï¸  No package.json found, skipping build validation"
            echo "build_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          BUILD_SCRIPT=$(jq -r '.scripts.build // empty' package.json)
          if [ -z "$BUILD_SCRIPT" ]; then
            echo "â„¹ï¸  No build script found in package.json, skipping build validation"
            echo "build_success=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Determine package manager
          if [ -f "pnpm-lock.yaml" ]; then
            PKG_MANAGER="pnpm"
          elif [ -f "yarn.lock" ]; then
            PKG_MANAGER="yarn"
          else
            PKG_MANAGER="npm"
          fi

          echo "ðŸ“¦ Using package manager: $PKG_MANAGER"

          # Build and auto-fix loop
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo ""
            echo "ðŸ”¨ Build Attempt $ATTEMPT of $MAX_ATTEMPTS..."

            # Try to build
            BUILD_OUTPUT=$(mktemp)
            if [ "$PKG_MANAGER" = "pnpm" ]; then
              pnpm build > "$BUILD_OUTPUT" 2>&1 && BUILD_SUCCESS=true || BUILD_SUCCESS=false
            elif [ "$PKG_MANAGER" = "yarn" ]; then
              yarn build > "$BUILD_OUTPUT" 2>&1 && BUILD_SUCCESS=true || BUILD_SUCCESS=false
            else
              npm run build > "$BUILD_OUTPUT" 2>&1 && BUILD_SUCCESS=true || BUILD_SUCCESS=false
            fi

            if [ "$BUILD_SUCCESS" = true ]; then
              echo "âœ… Build successful on attempt $ATTEMPT!"
              echo "build_success=true" >> $GITHUB_OUTPUT
              echo "build_attempts=$ATTEMPT" >> $GITHUB_OUTPUT
              rm -f "$BUILD_OUTPUT"
              exit 0
            fi

            # Build failed
            echo "âŒ Build failed on attempt $ATTEMPT"
            cat "$BUILD_OUTPUT"

            # If this was the last attempt, fail
            if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
              echo ""
              echo "ðŸ’” Build failed after $MAX_ATTEMPTS attempts. Giving up."
              echo "build_success=false" >> $GITHUB_OUTPUT
              echo "build_attempts=$ATTEMPT" >> $GITHUB_OUTPUT
              rm -f "$BUILD_OUTPUT"
              exit 1
            fi

            # Send webhook about fix attempt
            echo ""
            echo "ðŸ“¡ Sending webhook - AI attempting fix $ATTEMPT..."
            node ../retools-engine/scripts/webhook-driver.js \
              --job-id "${{ steps.parse.outputs.job_id }}" \
              --status "building" \
              --message "Build failed, AI attempting fix $ATTEMPT of 3..." \
              --webhook-url "${{ steps.parse.outputs.webhook_url }}"

            # Ask AI to fix the build error
            echo ""
            echo "ðŸ¤– Asking AI to fix build errors (attempt $ATTEMPT)..."

            # Create fix prompt with build error
            echo "The previous changes caused a build failure. Please analyze the build error below and fix the issues." > /tmp/fix_prompt.txt
            echo "" >> /tmp/fix_prompt.txt
            echo "BUILD ERROR:" >> /tmp/fix_prompt.txt
            cat "$BUILD_OUTPUT" >> /tmp/fix_prompt.txt

            # Run AI fix
            node ../retools-engine/scripts/ai-driver.js \
              --prompt "$(cat /tmp/fix_prompt.txt)" \
              --working-dir "$(pwd)" \
              --fix-mode

            # Commit the fix
            if [ -n "$(git status --porcelain)" ]; then
              git add .
              git commit -m "ðŸ”§ AI Auto-fix attempt $ATTEMPT: Fix build errors"
              echo "âœ… AI applied fixes, retrying build..."
            else
              echo "âš ï¸  AI made no changes, retrying anyway..."
            fi

            rm -f "$BUILD_OUTPUT"
            ATTEMPT=$((ATTEMPT + 1))
          done

      # ===================================================================
      # STEP 10: Send Webhook - Build Complete
      # ===================================================================
      - name: Webhook - Build Complete
        if: steps.build.outputs.build_success == 'true'
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          ATTEMPTS="${{ steps.build.outputs.build_attempts }}"
          if [ "$ATTEMPTS" = "1" ]; then
            MESSAGE="Build successful on first attempt"
          else
            MESSAGE="Build successful after $ATTEMPTS AI fix attempts"
          fi

          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "building" \
            --message "$MESSAGE" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 11: Send Webhook - Starting Deployment
      # Runs even if build failed â€” we still push the branch and open a PR.
      # ===================================================================
      - name: Webhook - Starting Deployment
        if: always()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "deploying" \
            --message "Pushing branch and creating pull request..." \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 12: Push Branch
      # Runs even if the build failed â€” we always push the AI's work so the
      # user can inspect, fix, and merge at their discretion.
      # ===================================================================
      - name: Push Branch
        id: push
        if: always()
        working-directory: ./repo
        run: |
          # Only push if there are commits beyond the base branch
          FEATURE_BRANCH="${{ steps.checkout.outputs.feature_branch }}"
          BASE_BRANCH="${{ steps.checkout.outputs.base_branch }}"

          COMMIT_COUNT=$(git rev-list --count "origin/${BASE_BRANCH}..HEAD" 2>/dev/null || echo "0")
          if [ "$COMMIT_COUNT" -eq 0 ]; then
            echo "âš ï¸  No commits on feature branch â€” nothing to push"
            echo "pushed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          USER_TOKEN=$(cat /tmp/user_github_token.txt)

          git remote set-url origin "https://x-access-token:${USER_TOKEN}@github.com/${{ steps.parse.outputs.repo_path }}.git"
          git push -u origin "$FEATURE_BRANCH"

          echo "feature_branch=$FEATURE_BRANCH" >> $GITHUB_OUTPUT
          echo "pushed=true" >> $GITHUB_OUTPUT
          echo "âœ… Branch pushed: $FEATURE_BRANCH"

      # ===================================================================
      # STEP 13: Create Pull Request
      # Opens a regular PR on build success; a draft PR on build failure so
      # the user can still review the AI's work and decide whether to merge.
      # ===================================================================
      - name: Create Pull Request
        id: pr
        if: steps.push.outputs.pushed == 'true'
        run: |
          USER_TOKEN=$(cat /tmp/user_github_token.txt)
          PROMPT=$(cat /tmp/prompt.txt)
          BASE_BRANCH="${{ steps.checkout.outputs.base_branch }}"
          FEATURE_BRANCH="${{ steps.push.outputs.feature_branch }}"
          BUILD_SUCCESS="${{ steps.build.outputs.build_success }}"

          # Draft PR if build failed â€” clearly signals it needs review before merge
          if [ "$BUILD_SUCCESS" = "true" ]; then
            DRAFT="false"
            TITLE="ðŸ¤– Noelle AI: ${PROMPT:0:72}"
            BODY="## AI-Generated Changes\n\n**Prompt:**\n\n${PROMPT}\n\n---\n\n*Generated by [Noelle](https://thenoelle.app) â€” AI-powered code changes*"
          else
            DRAFT="true"
            TITLE="âš ï¸ [Draft] Noelle AI: ${PROMPT:0:65}"
            BODY="## AI-Generated Changes *(build check did not pass)*\n\n**Prompt:**\n\n${PROMPT}\n\n---\n\n> âš ï¸ The automated build validation failed after 3 AI fix attempts. The changes are pushed here as a **draft PR** for your review. Please inspect the diff, fix any remaining issues, and mark the PR ready for review when it's good to merge.\n\n*Generated by [Noelle](https://thenoelle.app) â€” AI-powered code changes*"
          fi

          PR_RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $USER_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ steps.parse.outputs.repo_path }}/pulls" \
            -d "{
              \"title\": \"$TITLE\",
              \"body\": \"$BODY\",
              \"head\": \"$FEATURE_BRANCH\",
              \"base\": \"$BASE_BRANCH\",
              \"draft\": $DRAFT
            }")

          PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "draft=$DRAFT" >> $GITHUB_OUTPUT

          if [ "$DRAFT" = "true" ]; then
            echo "âš ï¸  Draft Pull Request created (build failed): $PR_URL"
          else
            echo "âœ… Pull Request created: $PR_URL"
          fi

      # ===================================================================
      # STEP 14: Poll for Vercel Preview URL
      # After the PR is opened, Vercel auto-deploys a preview build and
      # posts a comment on the PR. We poll GitHub PR comments for up to
      # 3 minutes looking for that comment.
      # ===================================================================
      - name: Poll for Vercel Preview URL
        id: vercel
        if: steps.pr.outputs.draft == 'false' && steps.pr.outputs.pr_number != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USER_TOKEN=$(cat /tmp/user_github_token.txt)
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          REPO_PATH="${{ steps.parse.outputs.repo_path }}"

          echo "â³ Waiting for Vercel preview deployment comment on PR #$PR_NUMBER..."

          PREVIEW_URL=""
          MAX_WAIT=180   # seconds
          INTERVAL=10
          ELAPSED=0

          while [ $ELAPSED -lt $MAX_WAIT ]; do
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
            echo "   Checking comments after ${ELAPSED}s..."

            # Fetch all PR comments using the user's token (works for private repos)
            COMMENTS=$(curl -s \
              -H "Authorization: Bearer $USER_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${REPO_PATH}/issues/${PR_NUMBER}/comments")

            # Look for a Vercel bot comment containing a preview URL
            PREVIEW_URL=$(echo "$COMMENTS" | jq -r '
              .[] |
              select(.user.login == "vercel[bot]" or (.body | test("vercel.app"))) |
              .body
            ' | grep -oP 'https://[a-zA-Z0-9\-]+\.vercel\.app[^\s")\]]*' | head -n 1 || true)

            if [ -n "$PREVIEW_URL" ]; then
              echo "âœ… Vercel preview URL found: $PREVIEW_URL"
              echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
              break
            fi
          done

          if [ -z "$PREVIEW_URL" ]; then
            echo "â„¹ï¸  No Vercel preview URL found within ${MAX_WAIT}s (repo may not be linked to Vercel)"
            echo "preview_url=" >> $GITHUB_OUTPUT
          fi

      # ===================================================================
      # STEP 15: Send Success/Draft Webhook
      # Fires whenever a PR was created (build passed OR draft on failure).
      # ===================================================================
      - name: Webhook - PR Created
        if: steps.pr.outputs.pr_url != '' && steps.pr.outputs.pr_url != 'null'
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          PREVIEW_URL="${{ steps.vercel.outputs.preview_url }}"
          IS_DRAFT="${{ steps.pr.outputs.draft }}"

          if [ "$IS_DRAFT" = "true" ]; then
            STATUS="preview_ready"
            MESSAGE="Draft PR created â€” build needs review before merging"
          else
            STATUS="preview_ready"
            MESSAGE="PR created successfully â€” ready for review and merge"
          fi

          CMD="node retools-engine/scripts/webhook-driver.js \
            --job-id \"${{ steps.parse.outputs.job_id }}\" \
            --status \"$STATUS\" \
            --message \"$MESSAGE\" \
            --pr-url \"${{ steps.pr.outputs.pr_url }}\" \
            --pr-number \"${{ steps.pr.outputs.pr_number }}\" \
            --webhook-url \"${{ steps.parse.outputs.webhook_url }}\""

          if [ -n "$PREVIEW_URL" ]; then
            CMD="$CMD --preview-url \"$PREVIEW_URL\""
          fi

          eval $CMD

      # ===================================================================
      # STEP 16: Send Failure Webhook
      # Only fires when no PR could be created at all (e.g., clone failed).
      # ===================================================================
      - name: Webhook - Failure
        if: failure() && (steps.pr.outputs.pr_url == '' || steps.pr.outputs.pr_url == 'null')
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node retools-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "failed" \
            --message "Workflow failed before a PR could be created â€” check logs" \
            --github-run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 17: Cleanup
      # ===================================================================
      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f /tmp/user_github_token.txt
          rm -f /tmp/job_payload.json
          rm -f /tmp/prompt.txt
          echo "âœ… Cleanup complete"


