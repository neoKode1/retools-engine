name: Retools PR Generator

on:
  workflow_dispatch:
    inputs:
      job_payload:
        description: 'JSON payload containing job details'
        required: true
        type: string

jobs:
  generate-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===================================================================
      # STEP 0: Checkout Pegasus Retools Engine (for scripts)
      # ===================================================================
      - name: Checkout Pegasus Retools Engine
        uses: actions/checkout@v4
        with:
          path: pegasus-engine

      # ===================================================================
      # STEP 1: Parse Job Payload
      # ===================================================================
      - name: Parse Job Payload
        id: parse
        run: |
          echo "Parsing job payload..."
          echo "${{ inputs.job_payload }}" > /tmp/job_payload.json
          
          JOB_ID=$(jq -r '.job_id' /tmp/job_payload.json)
          REPO_URL=$(jq -r '.repo_url' /tmp/job_payload.json)
          BRANCH=$(jq -r '.branch' /tmp/job_payload.json)
          PROMPT=$(jq -r '.prompt' /tmp/job_payload.json)
          WEBHOOK_URL=$(jq -r '.webhook_url' /tmp/job_payload.json)
          USER_EMAIL=$(jq -r '.user_email // empty' /tmp/job_payload.json)
          USER_NAME=$(jq -r '.user_name // empty' /tmp/job_payload.json)
          
          echo "job_id=$JOB_ID" >> $GITHUB_OUTPUT
          echo "repo_url=$REPO_URL" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT
          echo "webhook_url=$WEBHOOK_URL" >> $GITHUB_OUTPUT
          echo "user_email=$USER_EMAIL" >> $GITHUB_OUTPUT
          echo "user_name=$USER_NAME" >> $GITHUB_OUTPUT
          
          # Extract owner/repo from URL
          REPO_PATH=$(echo "$REPO_URL" | sed 's|https://github.com/||' | sed 's|\.git$||')
          echo "repo_path=$REPO_PATH" >> $GITHUB_OUTPUT
          
          # Store prompt in file (avoid command injection)
          echo "$PROMPT" > /tmp/prompt.txt
          
          echo "âœ… Parsed job: $JOB_ID for $REPO_PATH"

      # ===================================================================
      # STEP 2: Mask User GitHub Token
      # ===================================================================
      - name: Setup User GitHub Token
        id: token
        run: |
          # Extract and mask user's GitHub token
          USER_TOKEN=$(jq -r '.github_token' /tmp/job_payload.json)
          echo "::add-mask::$USER_TOKEN"
          
          # Store in temp file (never in GITHUB_OUTPUT)
          echo "$USER_TOKEN" > /tmp/user_github_token.txt
          chmod 600 /tmp/user_github_token.txt
          
          echo "âœ… User GitHub token masked and stored securely"

      # ===================================================================
      # STEP 3: Checkout User's Repository
      # ===================================================================
      - name: Checkout User Repository
        run: |
          echo "Cloning ${{ steps.parse.outputs.repo_url }}..."
          
          USER_TOKEN=$(cat /tmp/user_github_token.txt)
          
          # Clone with user's token
          git clone "https://x-access-token:${USER_TOKEN}@github.com/${{ steps.parse.outputs.repo_path }}.git" repo
          cd repo
          
          # Checkout target branch
          git checkout "${{ steps.parse.outputs.branch }}" || git checkout -b "${{ steps.parse.outputs.branch }}"
          
          # Configure git
          git config user.email "${{ steps.parse.outputs.user_email || 'retools@nexartis.com' }}"
          git config user.name "${{ steps.parse.outputs.user_name || 'Retools AI' }}"
          
          echo "âœ… Repository cloned and configured"

      # ===================================================================
      # STEP 4: Send Webhook - Cloning Complete
      # ===================================================================
      - name: Webhook - Cloning Complete
        if: always()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node pegasus-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "cloning_complete" \
            --message "Repository cloned successfully" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 5: Setup Node.js and Dependencies
      # ===================================================================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        run: npm install -g pnpm@9.0.0

      - name: Detect and Install Dependencies
        working-directory: ./repo
        run: |
          if [ -f "package.json" ]; then
            echo "ðŸ“¦ Installing Node.js dependencies..."
            if [ -f "pnpm-lock.yaml" ]; then
              pnpm install
            elif [ -f "yarn.lock" ]; then
              npm install -g yarn
              yarn install
            else
              npm install
            fi
          elif [ -f "requirements.txt" ]; then
            echo "ðŸ Installing Python dependencies..."
            pip install -r requirements.txt
          elif [ -f "Gemfile" ]; then
            echo "ðŸ’Ž Installing Ruby dependencies..."
            bundle install
          else
            echo "â„¹ï¸  No dependency file found, skipping install"
          fi

      # ===================================================================
      # STEP 6: Apply AI Changes
      # ===================================================================
      - name: Apply AI Changes with Claude
        working-directory: ./repo
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          echo "ðŸ¤– Applying AI changes..."

          PROMPT=$(cat /tmp/prompt.txt)

          # Use Claude API to generate changes
          node ../pegasus-engine/scripts/ai-driver.js \
            --prompt "$PROMPT" \
            --working-dir "$(pwd)"

          echo "âœ… AI changes applied"

      # ===================================================================
      # STEP 7: Commit Changes
      # ===================================================================
      - name: Commit Changes
        working-directory: ./repo
        run: |
          # Check if there are changes
          if [ -z "$(git status --porcelain)" ]; then
            echo "âš ï¸  No changes detected"
            exit 0
          fi

          git add .
          git commit -m "ðŸ¤– Retools AI: $(head -n 1 /tmp/prompt.txt | cut -c1-72)"

          echo "âœ… Changes committed"

      # ===================================================================
      # STEP 8: Send Webhook - AI Complete
      # ===================================================================
      - name: Webhook - AI Complete
        if: always()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node pegasus-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "ai_complete" \
            --message "AI changes applied and committed" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 9: Build Project (Optional)
      # ===================================================================
      - name: Build Project
        working-directory: ./repo
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            BUILD_SCRIPT=$(jq -r '.scripts.build // empty' package.json)
            if [ -n "$BUILD_SCRIPT" ]; then
              echo "ðŸ”¨ Building project..."
              pnpm build || npm run build || yarn build || true
            fi
          fi

      # ===================================================================
      # STEP 10: Push Branch
      # ===================================================================
      - name: Push Branch
        working-directory: ./repo
        run: |
          USER_TOKEN=$(cat /tmp/user_github_token.txt)

          # Create feature branch
          FEATURE_BRANCH="retools/ai-changes-$(date +%s)"
          git checkout -b "$FEATURE_BRANCH"

          # Push with user's token
          git remote set-url origin "https://x-access-token:${USER_TOKEN}@github.com/${{ steps.parse.outputs.repo_path }}.git"
          git push -u origin "$FEATURE_BRANCH"

          echo "feature_branch=$FEATURE_BRANCH" >> $GITHUB_OUTPUT
          echo "âœ… Branch pushed: $FEATURE_BRANCH"
        id: push

      # ===================================================================
      # STEP 11: Create Pull Request
      # ===================================================================
      - name: Create Pull Request
        id: pr
        run: |
          USER_TOKEN=$(cat /tmp/user_github_token.txt)
          PROMPT=$(cat /tmp/prompt.txt)

          # Create PR using GitHub API
          PR_RESPONSE=$(curl -X POST \
            -H "Authorization: Bearer $USER_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ steps.parse.outputs.repo_path }}/pulls" \
            -d "{
              \"title\": \"ðŸ¤– Retools AI: ${PROMPT:0:72}\",
              \"body\": \"## AI-Generated Changes\n\n**Prompt:**\n\n${PROMPT}\n\n---\n\n*Generated by [Retools](https://retools.dev) - AI-powered PR generator*\",
              \"head\": \"${{ steps.push.outputs.feature_branch }}\",
              \"base\": \"${{ steps.parse.outputs.branch }}\"
            }")

          PR_URL=$(echo "$PR_RESPONSE" | jq -r '.html_url')
          PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.number')

          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          echo "âœ… Pull Request created: $PR_URL"

      # ===================================================================
      # STEP 12: Send Success Webhook
      # ===================================================================
      - name: Webhook - Success
        if: success()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node pegasus-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "completed" \
            --message "PR created successfully" \
            --pr-url "${{ steps.pr.outputs.pr_url }}" \
            --pr-number "${{ steps.pr.outputs.pr_number }}" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 13: Send Failure Webhook
      # ===================================================================
      - name: Webhook - Failure
        if: failure()
        env:
          RETOOLS_WEBHOOK_SECRET: ${{ secrets.RETOOLS_WEBHOOK_SECRET }}
        run: |
          node pegasus-engine/scripts/webhook-driver.js \
            --job-id "${{ steps.parse.outputs.job_id }}" \
            --status "failed" \
            --message "Workflow failed - check logs" \
            --github-run-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --webhook-url "${{ steps.parse.outputs.webhook_url }}"

      # ===================================================================
      # STEP 14: Cleanup
      # ===================================================================
      - name: Cleanup Secrets
        if: always()
        run: |
          rm -f /tmp/user_github_token.txt
          rm -f /tmp/job_payload.json
          rm -f /tmp/prompt.txt
          echo "âœ… Cleanup complete"


